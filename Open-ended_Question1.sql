/*Who are Fetch’s power users?*/
-- Assumption: Power users are the top 1% users in total sales 

/* with 'UserStats' CTE, calculating total sales for each user */

WITH UserStats AS (
     SELECT 
        T.USER_ID,
        round(SUM(T.FINAL_SALE),2) AS total_sales -- summing the sales and rounding it to 2 decimals for total sales
     FROM 
        dbo.Transactions T
        left JOIN dbo.Users U ON T.USER_ID = U.ID -- using left join ensures no transaction data loss even when there are no matching records in other tables.
		
     GROUP BY  -- group by helps us to aggregate the values for each user
        T.USER_ID
),

-- Calculate thresholds for top 10 percentile in both total_sales and transaction_count
	 Thresholds AS (
		SELECT DISTINCT
			PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY total_sales) OVER() AS sales_threshold 
		FROM 
			UserStats
		
) 
		-- Identify power users
		SELECT  
			U.USER_ID,
			U.total_sales
   
		FROM 
			UserStats U
			CROSS JOIN Thresholds T -- Cross join will combine every row from first table with every row from second table
		WHERE 
			U.total_sales >= T.sales_threshold
			-- filtering here to select users who have threshold value or greater in their respective total sales and transactions
		ORDER BY 
			U.total_sales DESC

;



/* OUTPUT:
USER_ID	total_sales
65e4bc2716cc391732143569	88.37
60a5363facc00d347abadc8e	84.58
6183300cf998e47aad2d6f5d	82.28
6475fd16a55bb77a0e279ee0	77.8
643059f0838dd2651fb27f50	75.99
5d61b8e71ddc4058bd98f776	71.97
61aac8177c22c7641cc08fc4	70.66
642734743d4434e63c191488	69.2
636585d638ad5816d3937372	64.87
60c0aabdc66e105658856688	64.43
64c150a79b7ac0499fa5ad48	60.98
62535ab0fc0da6299a70f5ca	60.46
62474ee9ee2eea7d21cc1a66	59.97
631293bb09b563dae706d55f	59.95
5e2326e331cd04134507cbb4	59.94
646957617a342372c8575062	59.88
65845b6bc9e6fe40ea67e108	57.66
63c587b93d310dceeac95bce	57.31
5d77d06b0d1bff4316a3ef47	57.21
65d00704fe555d15f288ff6e	56.71
61d0aa0c52baef1444b555f6	56.22
5def096d9549bd11d36d926c	55.95
5dd2d373e08e92482002c1c0	55.94
6236a66e8096d0349b6de516	54.98
63d8337b55e4cd39e5e17ede	53.88
64c1afc79b7ac0499fa5c779	53.49
5f5fc49160803a1610c47e03	53.33
610b3d5002b8c34bbf3a589d	52.98
60bd286093170b617081a5d7	52.96
64cc3571f83efd697ff74d67	52.94
5f906764542e501679d188f4	52.93
62b367cbcc43018bbbfa69bc	52.9
61b8f27b49d675282481a4a0	52.86
621c117d5c050331cf8a65f9	51.83
62e79ae3a6565cf0534e0e8d	51.78
6367d6bcd7baff0f9f2b1629	51.42
653a0f40909604bae9071473	50.74
5b5cbbdbed93751899b99eb2	50.4
5ba2d0e6759081086af370f2	49.98
631b86a2198485e890005fbe	49.96
5e24d9fb0d22ea1309997680	49.95
6205459f29f0cb2c4a30b28a	48.99
656339da50f017da4e476bc1	48.12
5ef8d1de178c62142b64b1ba	47.99
61f4093fa043891075334468	47.84
62cebfc22cfb4591e3b9ff74	47.76
65fc57497756e548cb85d27c	47.47
5d2694486482b72774deac92	47.46
5fd40864a0d934474e874f71	46.98
6425cb1f14d232df87f33e75	46.95
661a9c27e7442746fa2b7767	46.92
64c521ae5f5a4d39d4d6c32f	46.49
665eb9ea7c0469953bfbf83f	46.29
5f7e54a9c98e38168ea79e93	46.21
636bf9cde81cf793db510ff7	45.99
638d2cbd90ad5449ec5ac359	44.99
5e14e6d1128c2c120e7e74db	44.99
5e0d3aa6fa89011209252706	44.98
5e3d987eeb76d4126a7488ae	44.98
63482b03be624cdd891555be	43.79
62689d92f4b142484fe52782	43.73
64904b4b127ddb5d7ffea5cb	43.49
6625803c89578edd4a1189e1	43.47
5e51ce6782e32c1342d817e8	42.98
5c338bc01662845f29c98ea2	42.97
5ec6c474ef6795140942f4e5	42.12
5ba835f1759081086a5b20d0	41.96
605a982894a5c74ba439e5ab	41.89
61bfb8b3967d3e5934a7a907	41.85
618c0b3a5e388d4f51332f8e	41.15
6610a65278ee6750bbc278a4	40.95
62f512be92710024adff69c0	40.82
644979fb347839fdfa9a4cda	40.7
62b72c2537e6e08b07750a90	40.54
5b971c0740c958323b50dee4	40.5
5fe2ab38587931128d28c820	40.48
60c809df7153fb41f0336f14	40.28
6622e0ed89578edd4a112b07	39.99
63d1411c39c79dcbdd62aed7	39.99
6206f90dcf52e347ba697a5f	39.99
660749566c9160420267fb01	39.97
66806caa465f309038adb60f	39.92
62a154951f9dbf1584c66ba8	39.38
666a2e417c0469953bfd9656	39.26
5f5d9952b12596160f11e835	38.49
60c3643e514aa130e3a4eac2	38.45
619c6018f998e47aad318354	38.43
60316ede521dd912dc83e2d6	38.26
64432ac1ee6ac839f8c93429	37.95
661036f96c91604202690f61	37.83
625b50c7152e472fe0e579be	37.67
65614d8750f017da4e471743	36.99
627ee3d81b06ad729e906a11	36.9
5efb5ca49193ee1425c33a25	36.89
6193231ae9b3d75037b0f928	36.56
62b8e15137e6e08b0775864e	36.48
62473c74834ddd30c4f13895	36.46
5f144b3dfecae81499c23e10	36.32
63e18360b425eb11a476104f	36.26
6394c27190ad5449ec618939	36.2
65483bc1a225ea102b8053f0	35.98
5e99ef0f126e4d138c7de171	35.98
662b04e48f6dede162ee2dcd	35.96
62a96c1f37737fe70d03e848	35.94
601b7fdac3dcfb1296de66d0	35.83
6204e4ed528f91023bac1658	35.45
651b8b1655f575777d10a22c	34.99
5eb59d6be7012d13941af5e2	34.99
5f60d79860803a1610c80a8e	34.97
623f868396e6b63587b1233d	34.9
63c9dacb39c79dcbdd5dab1c	34.77
5aef05b6e4b093b2e81979a4	34.69
6240f64ee073a81bcca57670	34.65
62099fee0ede521c349b0cb3	34.4
64e798baca929250373ea30d	34.37
65d4915916cc391732127174	34.27
62a7df837432fcef96d80c3d	34.26
63c1cb6d3d310dceeac55487	34.16
61bd1264b236450e975de9aa	33.99
648bb7a55da6e4734208ee29	33.99
62abe1ff165645ea96fe6ca3	33.98
62e17b031d76344f1a38c63c	33.98
6422d8d66c38ddd121a3f193	33.98
60d8ca886d77f345cec14dfa	33.97
6185d63a6f1d182a23c36d9f	33.92
63d27b1d51bfe6be4924b98c	33.75
5ff21324813c75128063c6aa	33.42
6174b3d26e2684498143fd27	33.06
63f1904938f010745b9a2b60	33.02
5d59f74fb292773b834ac591	33
63686df0790995659d9e9f7a	32.99
5c9e3994a921da135a538701	32.98
5e1219c0f3aee111fbbcea0e	32.94
65da0570fe555d15f28a1352	32.78
64a773da127ddb5d7f035c25	32.77
6270518c2d59654c5591e1a1	32.69
62ea96d2a6565cf0534fe5e2	32.55
61545c3b504f3536dc3423b6	32.51
667b2a73465f309038acebf4	32.46
625f0268e3a4a82bb440774e	32.41
65bfa5dbe43f8851491ca8dd	32.35
5f66397df123c1162fc18d68	32.25
60e7989216b87720250aae97	32.24
605bdfc2f4bbc2010444c5e4	32.02
6247c38275c2782062cc6266	32
665df27ce04f743a096d1fa1	31.99
5b993f4d40c9582af16923c4	31.98
6144de63af7cc6617cd55828	31.98
64c3dec3c40611ceadb152c6	31.98
60566a4b18fea0613d1eb30c	31.98
64ee34a9c65c76a8489dfdbc	31.97
64a440cf127ddb5d7f02c49d	31.95
60a97f0e188b926b22403f3f	31.94
5da93ee13484902390ea5231	31.94
5dc01d8c0239d62f09a7332c	31.9
5da24a23f310ed3d8f816427	31.89
5e056c3afa89011209c235ed	31.88
64bf45d69b7ac0499fa560c0	31.63
663bb2c1b7b24d45d93a7004	31.62
6248db87ee2eea7d21cc7221	31.55
629eb630d9666655703486e0	31.34
*/
